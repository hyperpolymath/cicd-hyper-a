{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://hyperpolymath.dev/schemas/cicd-hyper-a/arangodb",
  "title": "cicd-hyper-a ArangoDB Graph Schema",
  "description": "Graph schema for CI/CD intelligence platform",
  "definitions": {
    "repo": {
      "type": "object",
      "properties": {
        "_key": { "type": "string", "pattern": "^[a-zA-Z0-9_-]+$" },
        "name": { "type": "string" },
        "forge": { "enum": ["github", "gitlab", "bitbucket", "codeberg", "sourcehut", "gitea", "radicle"] },
        "owner": { "type": "string" },
        "url": { "type": "string", "format": "uri" },
        "visibility": { "enum": ["public", "private", "internal"] },
        "languages": { "type": "array", "items": { "type": "string" } },
        "lastScanned": { "type": "string", "format": "date-time" },
        "scorecardScore": { "type": "number", "minimum": 0, "maximum": 10 }
      },
      "required": ["_key", "name", "forge", "owner"]
    },
    "alert": {
      "type": "object",
      "properties": {
        "_key": { "type": "string" },
        "alertId": { "type": "string" },
        "category": {
          "enum": ["workflow-security", "code-security", "code-quality", "dependency-vuln", "process-hygiene", "missing-tests"]
        },
        "severity": { "enum": ["critical", "high", "medium", "low", "info"] },
        "ruleId": { "type": "string" },
        "description": { "type": "string" },
        "file": { "type": "string" },
        "line": { "type": "integer" },
        "autoFixable": { "type": "boolean" },
        "fixApplied": { "type": "boolean" },
        "dismissedAt": { "type": "string", "format": "date-time" },
        "createdAt": { "type": "string", "format": "date-time" }
      },
      "required": ["_key", "alertId", "category", "severity"]
    },
    "rule": {
      "type": "object",
      "properties": {
        "_key": { "type": "string" },
        "name": { "type": "string" },
        "effect": { "enum": ["preventive", "curative", "diagnostic"] },
        "source": { "enum": ["learned", "manual", "imported"] },
        "version": { "type": "string", "pattern": "^\\d+\\.\\d+\\.\\d+$" },
        "enabled": { "type": "boolean" },
        "triggerCount": { "type": "integer" },
        "successRate": { "type": "number", "minimum": 0, "maximum": 1 },
        "lastTriggered": { "type": "string", "format": "date-time" }
      },
      "required": ["_key", "name", "effect"]
    },
    "fix": {
      "type": "object",
      "properties": {
        "_key": { "type": "string" },
        "fixType": { "enum": ["replace", "inject", "delete", "command", "pr"] },
        "pattern": { "type": "string" },
        "replacement": { "type": "string" },
        "appliedCount": { "type": "integer" },
        "revertedCount": { "type": "integer" }
      },
      "required": ["_key", "fixType"]
    },
    "workflow": {
      "type": "object",
      "properties": {
        "_key": { "type": "string" },
        "name": { "type": "string" },
        "file": { "type": "string" },
        "hasSpdx": { "type": "boolean" },
        "hasPermissions": { "type": "boolean" },
        "allActionsPinned": { "type": "boolean" },
        "triggers": { "type": "array", "items": { "type": "string" } }
      },
      "required": ["_key", "name", "file"]
    }
  },
  "collections": {
    "repos": { "$ref": "#/definitions/repo" },
    "alerts": { "$ref": "#/definitions/alert" },
    "rules": { "$ref": "#/definitions/rule" },
    "fixes": { "$ref": "#/definitions/fix" },
    "workflows": { "$ref": "#/definitions/workflow" }
  },
  "edges": {
    "repo_has_alert": {
      "from": "repos",
      "to": "alerts"
    },
    "repo_has_workflow": {
      "from": "repos",
      "to": "workflows"
    },
    "alert_fixed_by": {
      "from": "alerts",
      "to": "rules"
    },
    "rule_applies_fix": {
      "from": "rules",
      "to": "fixes"
    },
    "workflow_triggers_rule": {
      "from": "workflows",
      "to": "rules"
    }
  },
  "graphs": {
    "cicd_graph": {
      "edgeDefinitions": [
        {
          "collection": "repo_has_alert",
          "from": ["repos"],
          "to": ["alerts"]
        },
        {
          "collection": "repo_has_workflow",
          "from": ["repos"],
          "to": ["workflows"]
        },
        {
          "collection": "alert_fixed_by",
          "from": ["alerts"],
          "to": ["rules"]
        },
        {
          "collection": "rule_applies_fix",
          "from": ["rules"],
          "to": ["fixes"]
        },
        {
          "collection": "workflow_triggers_rule",
          "from": ["workflows"],
          "to": ["rules"]
        }
      ]
    }
  }
}
